

心跳检测2秒1次，10s内节点没有回应，提出集群。

选举：
大多数原则的概念
当前复制集中，存活节点的数量必须大于节点总数的二分之一，才能触发选举，否则主节点降级为从节点。

1主1从：
	当主节点挂了，存活节点小于1/2,不会触发选举，从节点保持状态不会变。
	
	当从节点挂了，存活节点小于1/2,主节点降级为从节点，停止的写服务。


1主2从:
	当主节点挂了，2个从节点选举出一个主节点。当主节点恢复是，状态为从节点，如果优先级比选举出的高，则在数据同步完成后，在切换成主节点。

1主3从：
	当主节点挂了，3个从节点选举出一个主节点。
		当在挂掉一个主节点是，2个从节点，不会选举。
		当在挂掉一个从节点，则小于1/2,主节点降级为从节点。


复制集只计算节点数，不管节点是否正常，可以通过A节点，来激活复制集。
A节点

大多数原则：
	A机房4台机器，B机房3台机器，主节点在A机房。当AB机房之间线路故障，A机房复制集正常运行，B机房的从节点不会发生选举(3/7 < 1/2),只提供读服务，当网络恢复是，在与主节点同步数据。


选举触发的条件：
	1.主节点服务器down机
	2.主节点服务进程挂了
	3.主节点网络不可达
	4.人工干预rs.stepDown(600秒)主节点强制退位。 600秒内不参加选举

数据回滚：

	当从节点同步到95时，主节点服务挂了。
	P  95  96  97	98

	S  95

	S  95

	从节点发生选举，产生另外一个主,主节点开始写入数据，从节点开始同步。

	P  95  96  97	98

	P  95  96  97   98

	S  95  96  97   98 

	当主节点恢复是，发现数据不一致，会检测到96开始后，数据不一致，会回滚到95。与主节点同步数据。回滚后的数据放在rollback目录。

	S  95  96  97	98

	P  95  96  97   98

	S  95  96  97   98 
    
驱动API：
	正确配置mongodb的连接

	自动isMaster() 判断当前复制集的主节点是谁

	五种读策略：
		只读主，优先主，只读从，优先从，就近(网络延迟)


复制集状态：
1. STARTUP：刚加入到复制集中，配置还未加载
2. STARTUP2：配置已加载完，初始化状态
3. RECOVERING：正在恢复，不适用读
4. ARBITER: 仲裁者
5. DOWN：节点不可到达
6. UNKNOWN：未获取其他节点状态而不知是什么状态，一般发生在只有两个成员的架构，脑裂
7. REMOVED：移除复制集
8. ROLLBACK：数据回滚，在回滚结束时，转移到RECOVERING或SECONDARY状态
9. FATAL：出错。查看日志grep "replSet FATAL"找出错原因，重新做同步
10. PRIMARY：主节点
11. SECONDARY：备份节点 

